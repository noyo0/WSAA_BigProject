<!-- WSAA 2024 - BigProject (Truckwash) Author: Norbert Antal -->
<!--HTML-- ref (https://www.youtube.com/watch?v=38TeyubArgk&list=PLMZlcEhzqrV5pNo-f_9K11PJLlVPntqy7) -->
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script> <!--load AJAX-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script> <!--load Sweetalert-->
        <!-- CSS from bootstrap + font -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"> 
        <style>
            /* Custom CSS for rounded border */
            .rounded-container {
              border-radius: 15px; /* set radius */
            }
                .nav-link {
                    color: #12226c; /* text color */
                    background-color: white; /* background color to white */
                }
                .nav-link.active{
                    color: #12226c; /* active color */
                    background-color: white; /* background color to white */
                }
                .nav-link:hover {
                    color: white; /* Set text color to white for active and hover states */
                    background-color: #12226c; /* Set background color to black for active and hover states */
                }
                /* Custom CSS for rounded border */
                .rounded-container {
                    border-radius: 15px; /* Adjust the radius as needed */
                }        
          </style>

    <!-- Conditional title/ title from flask-->
    {% if title %}
        <title>Truckwash - {{ title }}</title>
    {% else %}
        <title>TruckWash</title>
    {% endif %}
<!--HTML-- -->
</head>
    <body style="font-family: 'Roboto', sans-serif;">
<!--main containers-- -->
<!--top image-- -->
<div class="container" style="background-image: url('img/bg_web.png'); background-size: contain; background-position: top; height: 320px; position: relative; background-repeat: no-repeat;">
        {% block content %}
        {% endblock %}
    </div>
<!-- bottom menu -->
<div class="container-fluid bg-light">
    <div class="row justify-content-center">
        <div class="col-auto">
            <a class="nav-link" id="home" data-toggle="pill" href="/" role="tab">Home</a>
        </div>
        <div class="col-auto">
            <a class="nav-link" id="v-pills-washlist-tab" data-toggle="pill" href="/washlist" role="tab">Wash List</a>
        </div>
        <div class="col-auto">
            <a class="nav-link" id="v-pills-addwash-tab" data-toggle="pill" href="/addwash" role="tab">Add Wash</a>
        </div>
        <div class="col-auto">
            <a class="nav-link active" id="v-pills-fleetlist-tab" data-toggle="pill" href="/fleetlist" role="tab">Fleet List</a>
        </div>
    </div>
</div>

    
</div>
    </body>

<!-- JavaScript-->
<script>
$(document).ready(function() {     //wait for the page to load before the scripts running

    function showCreate() {// show create section
        document.getElementById('button-showCreate').style.display = "none";
        document.getElementById('wash_list').style.display = "none";
        document.getElementById('createandUpdateForm').style.display = "block";
    }
    function showList() { // show list
        document.getElementById('button-showCreate').style.display = "block";
        document.getElementById('wash_list').style.display = "block";
        document.getElementById('createandUpdateForm').style.display = "none";
    }
    function doCreate(){ // create new database entry
        event.preventDefault();
        console.log("Adding a wash")
        storeFormValues()
        wash = storeFormValues()
        console.log(wash)
        clearForm()
        addWashToDatabase()
        //addWashToTable(wash)
        showList()
        }

function showUpdate(linkElement) {
    var rowElement = linkElement.parentNode.parentNode;
    console.log(rowElement);
}
    function doUpdate(){
        console.log("Updating a wash")
        }
        function doDelete(){
        wash_id = rowElement.cells[0].firstChild.textContent;
        console.log({wash_id})
        }
    function storeFormValues() {
        var form = document.getElementById('createUpdateForm');
        var wash = {};
        wash.date = form.querySelector('input[name="date"]').value;
        wash.fleetNumber = form.querySelector('input[name="fleet_number"]').value;
        wash.reg = form.querySelector('input[name="reg"]').value;
        wash.type = form.querySelector('select[name="type"]').value;
        return wash;
}
function clearForm() {
    var form = document.getElementById('createUpdateForm');
    form.querySelector('input[name="date"]').value = '';
    form.querySelector('input[name="fleet_number"]').value = '';
    form.querySelector('input[name="reg"]').value = '';
    form.querySelector('select[name="type"]').value = 'instock'; // Assuming 'instock' is the default option
}
    // UPDATE read out values from table row to update
        function getWashFromRow(rowElement) {
        var update_wash = {};
        truckwash.id = rowElement.cells[0].firstChild.textContent;
        truckwash.date = rowElement.cells[1].firstChild.textContent;
        truckwash.fleetNumber = rowElement.cells[2].firstChild.textContent;
        truckwash.reg = rowElement.cells[3].firstChild.textContent;
        truckwash.type = rowElement.cells[4].firstChild.textContent;
        return update_wash;
}
    // UPDATE populate a form with the data for update
    function populateFormWithWash(truckwash) {
        var form = document.getElementById('createUpdateForm');
        form.querySelector('input[name="id"]').disabled = true;
        form.querySelector('input[name="id"]').value = truckwash.id;
        form.querySelector('input[name="date"]').value = truckwash.date;
        form.querySelector('input[name="fleet_number"]').value = truckwash.fleetNumber;
        form.querySelector('input[name="reg"]').value = truckwash.reg;
        var selectElement = form.querySelector('select[name="type"]');
        selectElement.value = truckwash.type;
}
// -------------AJAX ----------------------- 

//-------------populate table from mysql with ajax -----------------
    // AJAX request to fetch data from Flask 
        $.ajax({
            url: "/getallSQL", // URL of the Flask route, that contains the DAO function to access mysql
            method: "GET", 
            dataType: "json", // expected data format as data in flask is jsonified
            success: function(data) { // data = DAO.getAll()
                populateTable(data); // java function defined below to populate table
            },
            error: function(xhr, status, error) { // error handling + write error to console
                console.error("Error fetching data:", error);
            }
        });
        function populateTable(data) { // populate table function called above
            var tableBody = $('#wash_list_table tbody'); // this is the HTML table element to populate
            tableBody.empty(); // Clear existing rows if there was anything in the table already
            data.forEach(function(row) { // populate from json where the keys are "Date", "FleetNumber", "Reg", "Type", and "id" + adds the extra buttons
                var newRow = '<tr>' +
                    '<td>' + row.id + '</td>' +
                    '<td>' + row.Date + '</td>' +
                    '<td>' + row.FleetNumber + '</td>' +
                    '<td>' + row.Reg + '</td>' +
                    '<td>' + row.Type + '</td>' +
                    '<td><a href="#" onclick="showUpdate(this)">Update</a></td>' +
                    '<td><a href="#" onclick="doDelete()">Delete</a></td>' +
                    '</tr>';
                tableBody.append(newRow);
            })
        }
    // AJAX Add wash to SQL---------------------
    function addWashToDatabase() {
        console.log(wash)
    var wash = storeFormValues(); // Get the form values

    // Send the wash data to the server using AJAX
    $.ajax({
        url: "/addwash", // URL of the Flask route that saves the new wash data
        method: "POST",
        data: JSON.stringify(wash),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(response) {
            populateTable([response]); // Add the new wash to the table
        },
        error: function(xhr, status, error) {
            console.error("Error saving wash data:", error);
        }
    })
    };
})
</script>
</html>