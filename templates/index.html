<!-- WSAA 2024 - BigProject (Truckwash) Author: Norbert Antal -->
<!-- this is the landing page containing cost summaries and data some simple visualisation -->
{% extends 'layout.html' %}
{% block content %}   
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- Plotly library for charts -->
<!-- side menu -->
<div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
    <div class="m-container" style="width: 180px; position: absolute; left: 10; top: 10;">
        <a class="nav-link active" id="home" data-toggle="pill" href="/" role="tab">Home</a>
        <a class="nav-link" id="v-pills-washlist-tab" data-toggle="pill" href="/washlist" role="tab">Wash History</a>
        <a class="nav-link" id="v-pills-addwash-tab" data-toggle="pill" href="/addwash" role="tab">Add Wash</a>
        <a class="nav-link" id="v-pills-fleetlist-tab" data-toggle="pill" href="/fleetlist" role="tab">Fleet List</a>
    </div>
</div>
</div>

<!-- Chart container-->
<div id="chart-container" class="container rounded-container border border-custom p-2 mt-2 shadow">
    <!-- The Chart (generated by plotly)-->
    <div id="chart" style="height: 300px;"></div>  
    <!-- Details button -->
    <div style="margin-top: 10px;"></div>
    <div style="display: flex; justify-content: center;">
        <button id="Details" class="btn btn-primary" style="background-color:#12226c" onclick="toggleVisibility('table_container')">Details</button>
        <button id="lineButton" class="btn btn-primary" style="background-color:#12226c" onclick="changeToLine()">Trends</button>
        <button id="barButton" class="btn btn-primary" style="background-color:#12226c" onclick="changeToBar()">Cost</button>
    </div>
</div>

<!-- The details Table -->
<div id="table_container" class="container rounded-container border border-custom p-4 mt-4" style="display: none; max-width: 100%;">
    <div id="summarized-table-container">
        <header class="p-4">
            <h3 style="color:#12226c;">Truckwash Summary</h3>
        </header>  
        <table id="Sum_table" class="table table-light table-striped-columns">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Month</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Cost By Type</th>
                    <th>Customer Monthly</th>
                </tr>
            </thead>
            <tbody>
                <!-- populated dynamically by AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- The monthly Summary Table -->
<div id="table_container" class="container rounded-container border border-custom p-4 mt-4" style="display: block; max-width: 100%;">
    <div id="SumMonth-table-container">
        <header class="p-4">
            <h3 style="color:#12226c;">Truckwash Monthly Summary</h3>
        </header>  
        <table id="SumMonth_table" class="table table-light table-striped-columns">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Month</th>
                    <th>Customer</th>
                    <th>Monthly Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- populated dynamically by AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!--------------------------------------------- JavaScript-------------------------------------------------------------------------------->
    <script>
          function toggleVisibility(elementId) { // show/hide panels
            var element = document.getElementById(elementId);
            if (element.style.display === "none") {
                element.style.display = "block";
            } else {
                element.style.display = "none";
            }
        }

        $(document).ready(function() {

//---------------- monthly summary overview ----------------------------------------

// Fetch the summarized Monthly wash data from the server using AJAX
fetch('/getWashSumMonth')
    .then(response => response.json())
    .then(data => {
        //console.log("getWashSumMonth SQL output:", data);
// Populate summarized wash data into the table
        populateMonthTable(data);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });

    function populateMonthTable(data) {
    var tableBody = $('#SumMonth_table tbody'); // table to populate
    tableBody.empty(); // Clear existing rows if there were any in the table already
    data.forEach(function(row) {
        // Format the rate/cost to EUR
        var formattedRate = Number(row.TotalRate).toLocaleString('en-US', { style: 'currency', currency: 'EUR' });
        var newRow = '<tr>' +
            '<td>' + row.Year + '</td>' +
            '<td>' + row.Month + '</td>' +
            '<td>' + row.Customer + '</td>' +
            '<td>' + formattedRate + '</td>' + // Use the formatted rate/cost here
            '</tr>';
        tableBody.append(newRow); // Appending the new row to the table body
    });
}

// ------------- summary details ----------------------------------------
// Fetch the summarized Detailed wash data from the server
fetch('/getWashSumJSON')
    .then(response => response.json())
    .then(data => {
        //console.log("getWashSumJSON SQL output:", data);
// Populate summarized wash data into the table
        populateTable(data);
// Generate the grouped bar chart using the fetched JSON data
        generateChart(data);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });

function populateTable(data) {
    var tableBody = $('#Sum_table tbody'); // table to populate
    tableBody.empty(); // Clear existing rows if there were any in the table already
    data.forEach(function(row) {
        var fTotalRate = Number(row.TotalRate).toLocaleString('en-US', { style: 'currency', currency: 'EUR' });
        var fCustomerMonthly = Number(row.CustomerMonthly).toLocaleString('en-US', { style: 'currency', currency: 'EUR' });
        var newRow = '<tr>' +
            '<td>' + row.Year + '</td>' +
            '<td>' + row.Month + '</td>' +
            '<td>' + row.Customer + '</td>' +
            '<td>' + row.Type + '</td>' +
            '<td>' + fTotalRate + '</td>' +
            '<td>' + fCustomerMonthly + '</td>' +
            '</tr>';
        tableBody.append(newRow); // Appending the new row to the table body
    });
}

// ------ C H A R T -------------------------------------------------
var traceData;
var layout;
// Function to generate the grouped bar chart
function generateChart(data) {
    // Group data by month and customer
    var groupedData = {};
    data.forEach(function(entry) {
        if (!groupedData[entry.Month]) {
            groupedData[entry.Month] = {};
        }
        groupedData[entry.Month][entry.Customer] = entry.CustomerMonthly;
    });
    // customers
    var customers = Object.keys(data.reduce(function(acc, obj) {
        acc[obj.Customer] = true;
        return acc;
    }, {}));
    // data for the chart
    traceData = [];
    customers.forEach(function(customer) {
        var costs = [];
        Object.keys(groupedData).forEach(function(month) {
            costs.push(groupedData[month][customer] || 0);
        });
        traceData.push({
            x: Object.keys(groupedData),
            y: costs,
            type: 'bar',
            name: customer
        });
    });

    // Define layout
    if (!layout) {
        layout = {
            barmode: 'group',
            title: {
                text: 'Cost per Customer for Each Month',
                yref: 'container',
                y: 0.9,
                yanchor: 'bottom'
            },
            xaxis: {
                title: 'Month',
                automargin: true
            },
            yaxis: {
                title: 'Cost â‚¬',
                automargin: true,
                titlepad: 400
            },
            margin: { l: 50, r: 40, t: 40, b: 40 }, // Adjust margins
            autosize: true,
            showlegend: true, // show legend inside
            legend: {
                x: 1,
                xanchor: 'right',
                y: 1
        }
    };
}
    // Plot the chart
    Plotly.newPlot('chart', traceData, layout);
}
        // Function to change chart type to line
        function changeToLine() {
                traceData.forEach(function(trace) {
                    trace.type = 'line';
                });
                Plotly.react('chart', traceData, layout);
            }

        // Function to change chart type to bar
        function changeToBar() {
            traceData.forEach(function(trace) {
                trace.type = 'bar';
            });
            Plotly.react('chart', traceData, layout);
        }
    // Event listener for button to change chart type to line
    document.getElementById('lineButton').addEventListener('click', function() {
        changeToLine();
    });

    // Event listener for button to change chart type to bar
    document.getElementById('barButton').addEventListener('click', function() {
        changeToBar();
    });
});
    </script>
{% endblock %}
